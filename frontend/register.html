<!DOCTYPE html>
<html>
<head>
    <title>UniSupport Registration Page</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f2f2f2; font-family: Arial, sans-serif; }
        .register-card { width: 350px; margin: 50px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        button { background: #007bff; color: white; border: none; }
        button:hover { background: #0056b3; }
        .required::after { content: " *"; color: #d63384; }
    </style>
</head>
<body>

<main class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card shadow p-4 w-100" style="max-width: 450px;">
        <h2 class="text-center mb-4">Create Account</h2>
        <div class="mb-3 text-end">
            <small class="text-muted">Already have an account? <a href="login.html">Sign in</a></small>
        </div>
        
        <form id="registerForm" novalidate>
            <div class="mb-3">
                <label for="full_name" class="required">Full Name</label>
                <input type="text" class="form-control" id="full_name" required>
                <div class="invalid-feedback">Full Name is required.</div>
            </div>

            <div class="mb-3">
                <label for="email" class="required">Email</label>
                <input type="email" class="form-control" id="email" required>
                <div class="invalid-feedback">Enter a valid email address.</div>
            </div>

            <div class="mb-3">
                <label for="password" class="form-label required">Password</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="password" required> 
                </div>
                <div class="form-text">At least 8 characters.</div>
                <div class="invalid-feedback">Password is required (min 8 chars).</div>
            </div>

            <div class="mb-3">
                <label for="confirmpassword" class="form-label required">Confirm Password</label>
                <input type="password" class="form-control" id="confirmpassword" required>
                <div class="invalid-feedback" id="confirmPasswordError">Passwords do not match.</div>
            </div>

            <button type="submit" class="btn btn-primary w-100">Create Account</button>
            <div class="alert mt-3 d-none" role="alert" id="statusMessage"></div>
        </form>

        <div class="text-end mt-3">
            <small>&copy; UniSupport</small>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    
    const API_URL = "http://localhost:8000/auth/register";

    const register = async (userData) => {
        const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(userData)
        });

        if (!response.ok) {
            const err = await response.json();
            
            if (err.detail && Array.isArray(err.detail)) {
                throw new Error(err.detail[0].msg + ": " + err.detail[0].loc[1]);
            }
            throw new Error(err.detail || "Registration failed");
        }

        return await response.json();
    };
    
    const registerForm = document.getElementById('registerForm');
    const statusMessage = document.getElementById('statusMessage');
    const emailInput = document.getElementById('email');

    const showAlert = (message, type) => {
        statusMessage.textContent = message;
        statusMessage.className = `alert mt-3 alert-${type}`;
        statusMessage.classList.remove('d-none');
    };

    const hideAlert = () => statusMessage.classList.add('d-none');

    registerForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        hideAlert();

        
        registerForm.classList.remove('was-validated');
        const allInputs = registerForm.querySelectorAll('input');
        allInputs.forEach(input => input.classList.remove('is-invalid'));

        
        const full_name = document.getElementById('full_name').value.trim(); 
        const email = emailInput.value.trim();
        const passwordInput = document.getElementById('password');
        const confirmInput = document.getElementById('confirmpassword');
        const password = passwordInput.value;
        const confirmPassword = confirmInput.value;

        
        let isValid = true;
        
        if (!full_name || !email || !password) {
            registerForm.classList.add('was-validated'); 
            isValid = false;
        }

        if (password.length < 8) { 
            passwordInput.classList.add('is-invalid'); 
            isValid = false; 
        }
        
        if (password !== confirmPassword) { 
            confirmInput.classList.add('is-invalid'); 
            isValid = false; 
        }

        if (!isValid) {
            showAlert('Please check the highlighted fields.', 'danger');
            return;
        }

        
        const userData = { 
            full_name: full_name,
            email: email, 
            password: password, 
            role: 'student' 
        };

        
        try {
            const submitButton = registerForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Creating Account...';

            await register(userData);

            showAlert('Registration successful! Redirecting to sign in...', 'success');
            setTimeout(() => { window.location.href = 'login.html'; }, 2000);

        } catch (error) {
            console.error("Registration failed:", error);
            const submitButton = registerForm.querySelector('button[type="submit"]');
            submitButton.disabled = false;
            submitButton.textContent = 'Create Account';

            const errorMessage = error.message || "An error occurred.";
            
            if (errorMessage.toLowerCase().includes('email')) {
                emailInput.classList.add('is-invalid');
            }
            showAlert(errorMessage, 'danger');
        }
    });
</script>

</body>
</html>